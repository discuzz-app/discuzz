(self.webpackChunkdiscuz=self.webpackChunkdiscuz||[]).push([[204],{3204:function(e,t,r){var o=r(995),n=r(573),a=r(2102),s=r(7313),u=r(118);function d(){return(d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e}).apply(this,arguments)}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),e.exports=function(e,t){try{var r=function(){e.recaptchaKey&&o.initializeAppCheck(i,{provider:new o.ReCaptchaV3Provider(e.recaptchaKey),isTokenAutoRefreshEnabled:!0});var t=function(e){return""===e||e===a.EMPTY_SYMBOL},r=function(e,t){try{return a.log("Update Doc",e.id,t),Promise.resolve(n.updateDoc(e,d({},t,{savedAt:n.serverTimestamp()})))}catch(e){return Promise.reject(e)}},l=function(e,t){try{return a.log("Add Doc",e.path,t,e),Promise.resolve(n.addDoc(e,d({},t,{savedAt:n.serverTimestamp()})))}catch(e){return Promise.reject(e)}},p=function(e){try{return a.log("Delete Doc",e),Promise.resolve(n.deleteDoc(e))}catch(e){return Promise.reject(e)}},h=function(e){try{var t=0===e.paths.length?void 0:e.paths[e.paths.length-1],o=function(){if(t){a.log("increase post replied",t);var e=n.doc(c,"posts",t);return Promise.resolve(r(e,{replied:n.increment(1)})).then((function(){}))}}();return Promise.resolve(o&&o.then?o.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},v={toFirestore:function(e){var t={id:e.id,paths:e.paths,parentId:e.parentId,url:e.url,author:{id:e.author.id},contents:e.contents,voted:e.voted,replied:e.replied,voters:e.voters};return e.author.photoUrl&&(t.author.photoUrl=e.author.photoUrl),e.author.name&&(t.author.name=e.author.name),e.approvedAt&&(t.approvedAt=e.approvedAt),e.savedAt&&(t.savedAt=e.savedAt),e.createdAt&&(t.createdAt=e.createdAt),e.updatedAt&&(t.updatedAt=e.updatedAt),e.deletedAt&&(t.deletedAt=e.deletedAt),t},fromFirestore:function(e,t){var r=e.data(t),o={id:e.id,paths:r.paths,parentId:r.parentId,url:r.url,author:{id:r.author.id,name:r.author.name,photoUrl:r.author.photoUrl},contents:r.contents,replied:r.replied,voted:r.voted,voters:r.voters,snapshot:e};return r.author.photoUrl&&(o.author.photoUrl=r.author.photoUrl),r.paths.length>0&&(o.parentId=r.paths[r.paths.length-1]),r.approvedAt&&(o.approvedAt=r.approvedAt.toDate()),r.savedAt&&(o.savedAt=r.savedAt.toDate()),r.createdAt&&(o.createdAt=r.createdAt.toDate()),r.updatedAt&&(o.updatedAt=r.updatedAt.toDate()),r.deletedAt&&(o.deletedAt=r.deletedAt.toDate()),o}},f={toFirestore:function(e){var t={id:e.id,paths:e.paths,url:e.url,author:{id:e.author.id},contents:e.contents};return e.author.photoUrl&&(t.author.photoUrl=e.author.photoUrl),e.author.name&&(t.author.name=e.author.name),e.postId&&(t.postId=e.postId),e.createdAt&&(t.createdAt=e.createdAt),e.updatedAt&&(t.updatedAt=e.updatedAt),e.deletedAt&&(t.deletedAt=e.deletedAt),t},fromFirestore:function(e,t){var r=e.data(t),o={id:e.id,paths:r.paths,url:r.url,author:{id:r.author.id,name:r.author.name,photoUrl:r.author.photoUrl},contents:r.contents};return r.author.photoUrl&&(o.author.photoUrl=r.author.photoUrl),r.paths.length>0&&(o.parentId=r.paths[r.paths.length-1]),r.postId&&(o.postId=r.postId),r.createdAt&&(o.createdAt=r.createdAt.toDate()),r.updatedAt&&(o.updatedAt=r.updatedAt.toDate()),r.deletedAt&&(o.deletedAt=r.deletedAt.toDate()),o}};return{usePostQuery:function(e){var t=s.useState(null),r=t[0],o=t[1],u=s.useState(a.RequestState.INITIAL),d=u[0],i=u[1],l=s.useCallback((function(e){o(e.data()),i(a.RequestState.SUCCESS)}),[o,i]);return s.useEffect((function(){var t=n.doc(c,"posts",e).withConverter(v);return i(a.RequestState.LOADING),n.onSnapshot(t,l)}),[e]),{post:r,queryState:d}},usePostListQuery:function(e,t,r){void 0===r&&(r=null);var o=u.useImmer([]),d=o[0],i=o[1],l=s.useState(a.RequestState.INITIAL),p=l[0],h=l[1],f=s.useState(!1),m=f[0],A=f[1],P=s.useState(null),S=P[0],g=P[1],y=s.useState(null),I=y[0],U=y[1],C=s.useCallback((function(e){var t=[];return e.forEach((function(e){var r=e.data();r.createdAt&&t.push(r)})),t}),[]),D=s.useCallback((function(e){var r=C(e);a.log("update posts from list",r),i((function(e){for(var t=0;t<r.length;t++)e.push(r[t])})),h(a.RequestState.SUCCESS),A(!(r.length<t))}),[i,C,h]),b=s.useCallback((function(e){var t=C(e);a.log("update posts from sub",t),i((function(e){for(var r=function(r){var o=t[r],n=e.findIndex((function(e){return e.id===o.id}));-1===n?(a.log("add post from sub",o.id,o),e.unshift(o)):(a.log("replace post from sub",o.id,o),e[n]=o)},o=t.length-1;o>=0;o--)r(o)}))}),[i,C]);s.useEffect((function(){d.length>0&&d[d.length-1].createdAt&&(null!==S&&S.id===d[d.length-1].id||g(d[d.length-1].snapshot))}),[d,S]),s.useEffect((function(){if(null===r||r.replied>0){var o=[n.where("url","==",e),n.where("parentId","==",r?r.id:null),n.orderBy("createdAt","desc"),n.limit(t)];null!==I&&o.push(n.startAfter(I)),h(a.RequestState.LOADING);var s=n.query.apply(void 0,[n.collection(c,"posts")].concat(o)).withConverter(v);n.getDocs(s).then(D).catch((function(e){a.fatal("query post failed",e),h(a.RequestState.FAIL)}))}else 0===r.replied&&h(a.RequestState.SUCCESS)}),[e,r,I,D,h]),s.useEffect((function(){if(p===a.RequestState.SUCCESS&&0===d.length){var t=[n.where("url","==",e),n.where("parentId","==",r?r.id:null),n.where("savedAt",">",new Date),n.orderBy("savedAt","desc")],o=n.query.apply(void 0,[n.collection(c,"posts")].concat(t)).withConverter(v);return n.onSnapshot(o,b)}return function(){}}),[p,d]),s.useEffect((function(){if(S){var t=[n.where("url","==",e),n.where("parentId","==",r?r.id:null),n.where("savedAt",">",new Date),n.orderBy("savedAt","desc"),n.endAt(S)],o=n.query.apply(void 0,[n.collection(c,"posts")].concat(t)).withConverter(v);return n.onSnapshot(o,b)}return function(){}}),[e,r,S,b]);var R=s.useCallback((function(){d.length>0&&U(d[d.length-1].snapshot)}),[d,U]);return{posts:d,loadMore:R,hasMore:null===r?m:r.replied>d.length,queryState:p}},useAddPostCommand:function(){var e=a.useAuth(),r=e.user,o=e.signInAnonymously;return s.useCallback((function(e,s,u){try{var i=function(){var t={paths:u?[].concat(u.paths,[u.id]):[],parentId:u?u.id:null,url:u?u.url:s,author:{id:p.uid,name:p.displayName,photoUrl:p.photoURL||""},contents:e,createdAt:n.serverTimestamp()};if(p.canSavePost){var r,o=d({},t,{voted:1,replied:0,voters:(r={},r[p.uid]=1,r),approvedAt:n.serverTimestamp()});return a.log("add post directly",o),Promise.resolve(l(n.collection(c,"posts"),o)).then((function(){return Promise.resolve(h(o)).then((function(){return a.PostUpdateResult.UPDATED}))}))}var i=d({},t);return Promise.resolve(l(n.collection(c,"pending_posts"),i)).then((function(){return a.PostUpdateResult.PENDING}))};if(t(e))return Promise.resolve(a.PostUpdateResult.INVALID);var p=r,v=function(){if(p&&!p.uid)return Promise.resolve(o()).then((function(e){p=e}))}();return Promise.resolve(v&&v.then?v.then(i):i())}catch(e){return Promise.reject(e)}}),[o,r])},useEditPostCommand:function(){var e=a.useAuth().user;return s.useCallback((function(o,s){try{if(t(s))return Promise.resolve(a.PostUpdateResult.INVALID);var u={contents:s,updatedAt:n.serverTimestamp()};if(e.canSavePost){var i=n.doc(c,"posts",o.id),p=d({},u);return Promise.resolve(r(i,p)).then((function(){return a.PostUpdateResult.UPDATED}))}var h=d({},u,{postId:o.id,paths:[],parentId:null,author:{id:e.uid,name:"",photoUrl:""}});return Promise.resolve(l(n.collection(c,"pending_posts"),h)).then((function(){return a.PostUpdateResult.PENDING}))}catch(e){return Promise.reject(e)}}),[e])},useRemovePostCommand:function(){return s.useCallback((function(e){try{var t=n.doc(c,"posts",e.id);return Promise.resolve(r(t,{contents:"",deletedAt:n.serverTimestamp()})).then((function(){return a.PostUpdateResult.UPDATED}))}catch(e){return Promise.reject(e)}}),[])},useTogglePostVoteCommand:function(){var e=a.useAuth(),t=e.user,o=e.signIn;return s.useCallback((function(e){try{if(null!=t&&t.emailVerified){var s=function(){return a.PostUpdateResult.UPDATED};a.log("toggle vote",e.id,"voters",e.voters,"from",t.uid);var u=n.doc(c,"posts",e.id),d=e.voters[t.uid]?(a.log("remove vote",t.uid),Promise.resolve(r(u,(i={},i["voters."+t.uid]=n.deleteField(),i.voted=n.increment(-1),i))).then((function(){}))):(a.log("add vote",t.uid),Promise.resolve(r(u,(l={},l["voters."+t.uid]=1,l.voted=n.increment(1),l))).then((function(){})));return Promise.resolve(d&&d.then?d.then(s):s())}return o(),Promise.resolve(a.PostUpdateResult.INVALID)}catch(e){return Promise.reject(e)}var i,l}),[t])},usePendingPostQuery:function(){var e=a.useAuth().user,t=s.useState([]),r=t[0],o=t[1],u=s.useCallback((function(e){var t=[];e.forEach((function(e){t.push(e.data())})),o(t)}),[o]);return s.useEffect((function(){if(e&&e.isAdmin){var t=n.query(n.collection(c,"pending_posts")).withConverter(f);return n.getDocs(t).then(u).catch(console.error),n.onSnapshot(t,u)}return function(){}}),[e,u]),{pendingPosts:r}},useEditPendingPostCommand:function(){var e=a.useAuth();return s.useCallback((function(e,t){try{if(function(e){return!e||e===a.EMPTY_SYMBOL}(t))return Promise.resolve(a.PendingPostUpdateResult.FAIL);var o=n.doc(c,"pending_posts",e.id);return Promise.resolve(r(o,{contents:t,updatedAt:n.serverTimestamp()})).then((function(){return a.PendingPostUpdateResult.SUCCESS}))}catch(e){return Promise.reject(e)}}),[e.user])},useRejectPendingPostCommand:function(){var e=a.useAuth();return s.useCallback((function(e){try{var t=n.doc(c,"pending_posts",e.id);return Promise.resolve(p(t)).then((function(){return a.PendingPostUpdateResult.SUCCESS}))}catch(e){return Promise.reject(e)}}),[e.user])},useApprovePendingPostCommand:function(){var e=a.useAuth();return s.useCallback((function(e){try{var t=n.doc(c,"pending_posts",e.id);return Promise.resolve(n.getDoc(t)).then((function(o){function s(){return Promise.resolve(p(t)).then((function(){return a.PendingPostUpdateResult.SUCCESS}))}var u={approvedAt:n.serverTimestamp(),savedAt:n.serverTimestamp()},i=o.data(),v=function(){if(e.postId){var t=n.doc(c,"posts",e.postId);return Promise.resolve(r(t,d({},u,{contents:i.contents,updatedAt:i.updatedAt}))).then((function(){}))}var o;return Promise.resolve(l(n.collection(c,"posts"),d({},i,u,{replied:0,voted:1,voters:(o={},o[i.author.id]=1,o)}))).then((function(){h(i)}))}();return v&&v.then?v.then(s):s()}))}catch(e){return Promise.reject(e)}}),[e.user])}}},i=t.data.app,c=n.getFirestore(i),l=function(e,t){try{var r=Promise.resolve(n.enableIndexedDbPersistence(c)).then((function(){}))}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}(0,(function(e){console.error("Offline support failed!",e)}));return Promise.resolve(l&&l.then?l.then(r):r())}catch(o){return Promise.reject(o)}}}}]);